From 7bfa98fbfb6c92f39a3aca72fc6b6ef52b94d409 Mon Sep 17 00:00:00 2001
From: h4x <dstack@phala.network>
Date: Sat, 25 Oct 2025 14:55:02 +0000
Subject: [PATCH] dma-direct: downgrade coherent pool warning on TDX guests

TDX guests rely on SWIOTLB bounce buffering for NVMe, so the nvme
driver ends up calling into dma_direct_alloc_from_pool() from an
atomic context. Our tiny x86 defconfig does not enable
CONFIG_DMA_COHERENT_POOL, which causes the WARN_ON_ONCE() in that
helper to fire on every boot. The WARN splat is noisy and obscures
more actionable kernel messages, even though the code falls back to
the standard page allocator and continues to work.

Until we ship a coherent DMA pool for this configuration, convert the
WARN into a single informational message so the kernel log stays
readable while the fallback remains intact.

Signed-off-by: h4x <dstack@phala.network>
Upstream-Status: Inappropriate [TDX-specific logging tweak]
---
diff --git a/kernel/dma/direct.c b/kernel/dma/direct.c
--- a/kernel/dma/direct.c
+++ b/kernel/dma/direct.c
@@ -175,8 +175,10 @@
 	u64 phys_limit;
 	void *ret;
 
-	if (WARN_ON_ONCE(!IS_ENABLED(CONFIG_DMA_COHERENT_POOL)))
+	if (!IS_ENABLED(CONFIG_DMA_COHERENT_POOL)) {
+		pr_warn_once("dma-direct: coherent pool unavailable, falling back to page allocator\n");
 		return NULL;
+	}
 
 	gfp |= dma_direct_optimal_gfp_mask(dev, &phys_limit);
 	page = dma_alloc_from_pool(dev, size, &ret, gfp, dma_coherent_ok);

-- 
2.46.0
