#!/bin/bash
shopt -s nullglob

if [ -n "$BASH_SOURCE" ]; then
    THIS_SCRIPT=$BASH_SOURCE
elif [ -n "$ZSH_NAME" ]; then
    THIS_SCRIPT=$0
else
    THIS_SCRIPT="$(pwd)/dev-setup"
    if [ ! -e "$THIS_SCRIPT" ]; then
        echo "Error: $THIS_SCRIPT doesn't exist!" >&2
        echo "Please run this script in dev-setup's directory." >&2
        exit 1
    fi
fi
THIS_SCRIPT=$(realpath "$THIS_SCRIPT")
THIS_DIR=$(dirname "$THIS_SCRIPT")

LAYERS="$THIS_DIR/meta-confidential-compute \
    $THIS_DIR/meta-openembedded/meta-oe \
    $THIS_DIR/meta-openembedded/meta-python \
    $THIS_DIR/meta-openembedded/meta-networking \
    $THIS_DIR/meta-openembedded/meta-filesystems \
    $THIS_DIR/meta-virtualization \
    $THIS_DIR/meta-rust-bin \
    $THIS_DIR/meta-security \
    $THIS_DIR//meta-security/meta-tpm \
    $THIS_DIR/meta-dstack"

if [ -z "$1" ]; then
    BUILD_DIR=$THIS_DIR/bb-build
else
    BUILD_DIR=$(realpath "$1")
fi

# Sync build config from meta-dstack/conf (always overwrite)
CONF_SRC=$THIS_DIR/meta-dstack/conf
mkdir -p "$BUILD_DIR/conf"
cp -f "$CONF_SRC/local.conf" "$BUILD_DIR/conf/local.conf"
cp -rf "$CONF_SRC/multiconfig" "$BUILD_DIR/conf/"

OE_INIT=$THIS_DIR/openembedded-core/oe-init-build-env

for script in $THIS_DIR/setup.d/*.sh; do
    source "$script"
done

pushd "$BUILD_DIR"
BDIR="." TEMPLATECONF=$THIS_DIR/meta-yocto/meta-poky/conf/templates/default source $OE_INIT
popd

bitbake-layers add-layer $LAYERS

# Add scripts/bin to PATH if not already present
if [[ ":$PATH:" != *":$THIS_DIR/scripts/bin:"* ]]; then
    export PATH=$PATH:$THIS_DIR/scripts/bin
fi
